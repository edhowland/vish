#!/usr/bin/env ruby
# ivs.erb - template for compiler output to  ivs executable
# 

require 'optparse'
require_relative '../runtime/vish_runtime'
### Foreign requires with -r, --require vishc compiler flag(s)

###

opt=OptionParser.new do |o|
  o.banner = 'ivs - Interactive Vish shell'
  o.separator  ''
  o.on('-r file', '--require file', String, 'Require extra file before starting') do |file|
    require file
  end
  o.separator  ''

  o.on('-h', '--help', 'Displays this help') { puts o; exit() }
  o.on('-v', '--version', 'Display the version of Vish') { puts Vish::VERSION; exit }
end
opt.parse!
### Included files with -i, --include vishc compiler flag(s)

## Included file: ./parser_lib.rb
# parser_lib.rb - module ParserLib
require_relative '../lib/vish'

module ParserLib
  def self.parse(string)
    c = VishCompiler.new string
    c.parse
    c.transform
    c.ast
  end
  ## _emit(AST) :  Given a AST node subtree, return the emitted bytecodes
  def self._emit(ast)
    Semit.new.emit(ast)
  end
end

Dispatch << ParserLib

## end of  file: ./parser_lib.rb

###

ctx = Context.new
bc = ByteCodes.new
### emission of bytecodes
bc.codes = [:cls, :pushl, :mkattr, :pushl, [:pushl, :v, :swp, :set, :drop, :pushl, :k, :swp, :set, :drop], :pushl, [:pushl, :s, :pushv, :k, :pushl, "!", :pushl, 2, :pushl, :cat, :icall, :pushl, 1, :pushv, :mksym, :ncall, :assign, :pushv, :k, :pushl, [], :pushl, [:pushv, :v], :pushl, :Object_3fc479e07f7c, :pushl, 3, :pushl, :_mklambda, :icall, :pushl, 2, :pushv, :mkpair, :ncall, :pushv, :s, :pushl, [:pushl, :x, :swp, :set, :drop], :pushl, [:pushl, :v, :pushv, :x, :assign, :pushv, :v], :pushl, :Object_3fc479e07a04, :pushl, 3, :pushl, :_mklambda, :icall, :pushl, 2, :pushv, :mkpair, :ncall, :pushl, 2, :pushv, :mkobject, :ncall], :pushl, :Object_3fc479e07630, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :keys, :pushl, [:pushl, :obj, :swp, :set, :drop], :pushl, [:pushv, :obj, :pushl, :keys, :pushl, 2, :pushv, :xmit, :ncall], :pushl, :Object_3fc479e070e0, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :values, :pushl, [:pushl, :obj, :swp, :set, :drop], :pushl, [:pushv, :obj, :pushl, :values, :pushl, 2, :pushv, :xmit, :ncall], :pushl, :Object_3fc479e06c44, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :car, :pushl, [:pushl, :l, :swp, :set, :drop], :pushl, [:pushv, :l, :pushl, 1, :pushv, :key, :ncall], :pushl, :Object_3fc479e06730, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :cdr, :pushl, [:pushl, :l, :swp, :set, :drop], :pushl, [:pushv, :l, :pushl, 1, :pushv, :value, :ncall], :pushl, :Object_3fc479e061e0, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :cadr, :pushl, [:pushl, :l, :swp, :set, :drop], :pushl, [:pushv, :l, :pushl, 1, :pushv, :cdr, :ncall, :pushl, 1, :pushv, :car, :ncall], :pushl, :Object_3fc479e05ccc, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :cddr, :pushl, [:pushl, :l, :swp, :set, :drop], :pushl, [:pushv, :l, :pushl, 1, :pushv, :cdr, :ncall, :pushl, 1, :pushv, :cdr, :ncall], :pushl, :Object_3fc479e056c8, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :caddr, :pushl, [:pushl, :l, :swp, :set, :drop], :pushl, [:pushv, :l, :pushl, 1, :pushv, :cddr, :ncall, :pushl, 1, :pushv, :car, :ncall], :pushl, :Object_3fc479e05100, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :cdddr, :pushl, [:pushl, :l, :swp, :set, :drop], :pushl, [:pushv, :l, :pushl, 1, :pushv, :cddr, :ncall, :pushl, 1, :pushv, :cdr, :ncall], :pushl, :Object_3fc479e04b38, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :list_length, :pushl, [:pushl, :l, :swp, :set, :drop], :pushl, [:pushv, :l, :pushl, 1, :pushv, :null?, :ncall, :jmprf, 4, :pushl, 0, :fret, :pushl, 1, :pushv, :l, :pushl, 1, :pushv, :cdr, :ncall, :pushl, 1, :pushv, :list_length, :ncall, :add], :pushl, :Object_3fc479e04174, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :undefined?, :pushl, [:pushl, :key, :swp, :set, :drop], :pushl, [:pushv, :key, :pushl, 0, :pushv, :binding, :ncall, :pushl, 2, :pushv, :_undefined?, :ncall], :pushl, :Object_3fc479e01adc, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :map, :pushl, [:pushl, :fn, :swp, :set, :drop, :pushl, :coll, :swp, :set, :drop], :pushl, [:pushv, :coll, :pushl, 1, :pushv, :empty?, :ncall, :jmprf, 7, :pushl, 0, :pushl, :mkvector, :icall, :fret, :pushv, :coll, :pushl, 1, :pushv, :head, :ncall, :pushl, 1, :pushv, :fn, :ncall, :pushl, 1, :pushl, :mkvector, :icall, :pushv, :coll, :pushl, 1, :pushv, :tail, :ncall, :pushv, :fn, :pushl, 2, :pushv, :map, :ncall, :add], :pushl, :Object_3fc479e00dbc, :pushl, 3, :pushl, :_mklambda, :icall, :assign, :pushl, :null, :pushl, 0, :pushv, :mknull, :ncall, :assign, :pushl, :version, :pushl, 0, :pushv, :version, :ncall, :assign, :pushl, :argv, :pushl, 0, :pushv, :getargs, :ncall, :assign, :pushv, :argv, :pushl, 1, :pushv, :empty?, :ncall, :jmprf, 3, :jmpr, 45, :pushl, :src, :pushv, :argv, :pushl, 1, :pushv, :head, :ncall, :pushl, 1, :pushv, :fread, :ncall, :assign, :pushv, :src, :pushl, 1, :pushv, :parse, :ncall, :pushl, 1, :pushv, :_emit, :ncall, :pushl, 1, :pushl, :_call, :icall, :pushl, :argv, :pushv, :argv, :pushl, 1, :pushv, :tail, :ncall, :assign, :jmpr, -54, :pushl, "vish>", :pushl, 1, :pushv, :prints, :ncall, :pushl, :src, :pushl, 0, :pushv, :read, :ncall, :assign, :pushv, :src, :pushl, 1, :pushv, :empty?, :ncall, :jmprt, 23, :pushv, :src, :pushl, 1, :pushv, :parse, :ncall, :pushl, 1, :pushv, :_emit, :ncall, :pushl, 1, :pushv, :_call, :ncall, :pushl, 1, :pushv, :print, :ncall, :jmpr, -47, :halt]
###
ci = CodeInterpreter.new bc, ctx

# Main
p ci.run
